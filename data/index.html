<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Plantas IoT</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
</head>

<body>

    <div class="container">
        <header>
            <h1>üå± Smart Plant Monitor</h1>
            <div id="connection-status" class="status-badge disconnected">Desconectado</div>
        </header>

        <div id="alert-container" class="alert-box hidden">
            <span id="alert-message">‚ö†Ô∏è Alerta: Niveles normales</span>
        </div>

        <div class="dashboard-grid">

            <div class="card" id="card-humedad">
                <h3>üíß Humedad del Suelo</h3>
                <div class="value-container">
                    <span id="val-humedad">--</span><span class="unit">%</span>
                </div>
                <p class="subtitle" id="status-humedad">Esperando datos...</p>
            </div>

            <div class="card" id="card-temp">
                <h3>üå°Ô∏è Temperatura</h3>
                <div class="value-container">
                    <span id="val-temp">--</span><span class="unit">¬∞C</span>
                </div>
                <p class="subtitle" id="status-temp">Ambiente</p>
            </div>

            <div class="card" id="card-luz">
                <h3>‚òÄÔ∏è Luminosidad</h3>
                <div class="value-container">
                    <span id="val-luz">--</span><span class="unit">lx</span>
                </div>
                <p class="subtitle" id="status-luz">Sensor LDR</p>
            </div>

            <div class="card" id="card-pir">
                <h3>üëÄ √öltimo Movimiento</h3>
                <div class="value-text" id="val-pir">
                    Sin detecci√≥n reciente
                </div>
                <p class="subtitle">Registro de actividad</p>
            </div>

            <!-- === KPI 6: EXTREMOS DEL D√çA === -->
            <div class="card wide-card">
                <h3>üìä Extremos del D√≠a (√öltimas 24h)</h3>
                <div class="extremos-grid">
                    <div class="extremo-item">
                        <span class="extremo-label">Humedad M√°x:</span>
                        <span class="extremo-value" id="kpi6-hum-max">--</span><span class="unit">%</span>
                    </div>
                    <div class="extremo-item">
                        <span class="extremo-label">Humedad M√≠n:</span>
                        <span class="extremo-value" id="kpi6-hum-min">--</span><span class="unit">%</span>
                    </div>
                    <div class="extremo-item">
                        <span class="extremo-label">Temp M√°x:</span>
                        <span class="extremo-value" id="kpi6-temp-max">--</span><span class="unit">¬∞C</span>
                    </div>
                    <div class="extremo-item">
                        <span class="extremo-label">Temp M√≠n:</span>
                        <span class="extremo-value" id="kpi6-temp-min">--</span><span class="unit">¬∞C</span>
                    </div>
                </div>
                <div class="grafana-container" style="margin-top: 15px;">
                    <iframe 
                        src="http://localhost:3000/d-solo/adn8fg2/extremos-dia?orgId=1&from=now-6h&to=now&timezone=browser&theme=dark&panelId=panel-1" 
                        width="100%" 
                        height="250" 
                        frameborder="0">
                    </iframe>
                </div>
            </div>

            <!-- === KPI 7: HORAS EN ESTR√âS === -->
            <div class="card wide-card">
                <h3>‚è±Ô∏è Horas en Condici√≥n de Estr√©s (24h)</h3>
                <div class="estres-grid">
                    <div class="estres-item">
                        <span class="estres-label">Humedad Cr√≠tica:</span>
                        <span class="estres-value" id="kpi7-hum">0</span><span class="unit">h</span>
                    </div>
                    <div class="estres-item">
                        <span class="estres-label">Temperatura Cr√≠tica:</span>
                        <span class="estres-value" id="kpi7-temp">0</span><span class="unit">h</span>
                    </div>
                    <div class="estres-item">
                        <span class="estres-label">Poca Luz:</span>
                        <span class="estres-value" id="kpi7-luz">0</span><span class="unit">h</span>
                    </div>
                </div>
                <div class="grafana-container" style="margin-top: 15px;">
                    <iframe 
                        src="http://localhost:3000/d-solo/adlhh2r/horas-estre?orgId=1&from=now-6h&to=now&timezone=browser&theme=dark&panelId=panel-1" 
                        width="100%" 
                        height="250" 
                        frameborder="0">
                    </iframe>
                </div>
            </div>

            <!-- === KPI 8: TASA DE SECADO === -->
            <div class="card">
                <h3>üí® Tasa de Secado</h3>
                <div class="value-container">
                    <span id="kpi8-tasa">--</span><span class="unit">%/d√≠a</span>
                </div>
                <p class="subtitle" id="kpi8-status">Velocidad de cambio</p>
            </div>

            <!-- === KPI 8: GR√ÅFICA TASA DE SECADO === -->
            <div class="card wide-card">
                <h3>üí® Tendencia de Tasa de Secado</h3>
                <div class="grafana-container">
                    <iframe 
                        src="http://localhost:3000/d-solo/adppr4r/tasa-secadp?orgId=1&from=now-6h&to=now&timezone=browser&theme=dark&panelId=panel-1" 
                        width="100%" 
                        height="250" 
                        frameborder="0">
                    </iframe>
                </div>
            </div>

            <!-- === KPI 9: ESTADO DEL DISPOSITIVO === -->
            <div class="card" id="card-conexion">
                <h3>üì° Estado del Dispositivo</h3>
                <div class="value-text" id="kpi9-tiempo">
                    Calculando...
                </div>
                <p class="subtitle" id="kpi9-status">√öltima conexi√≥n</p>
            </div>

            <!-- === KPI 9: GR√ÅFICA ESTADO DISPOSITIVO === -->
            <div class="card wide-card">
                <h3>üì° Historial de Conexi√≥n</h3>
                <div class="grafana-container">
                    <iframe 
                        src="http://localhost:3000/d-solo/ad8md5s/estado-dispositivo?orgId=1&from=now-6h&to=now&timezone=browser&theme=dark&panelId=panel-1" 
                        width="100%" 
                        height="250" 
                        frameborder="0">
                    </iframe>
                </div>
            </div>

            <!-- === KPI 10: FRECUENCIA DE ALERTAS === -->
            <div class="card">
                <h3>üîî Frecuencia de Alertas</h3>
                <div class="alertas-container">
                    <div class="alerta-item">
                        <span class="alerta-label">Humedad Cr√≠tica (7d):</span>
                        <span class="alerta-value" id="kpi10-hum">0</span>
                    </div>
                    <div class="alerta-item">
                        <span class="alerta-label">Movimientos (24h):</span>
                        <span class="alerta-value" id="kpi10-pir">0</span>
                    </div>
                </div>
            </div>

            <!-- === KPI 10: GR√ÅFICA FRECUENCIA ALERTAS === -->
            <div class="card wide-card">
                <h3>üîî Historial de Alertas</h3>
                <div class="grafana-container">
                    <iframe 
                        src="http://localhost:3000/d-solo/adpwcnj/frecuencia-alertas?orgId=1&from=now-6h&to=now&timezone=browser&theme=dark&panelId=panel-1" 
                        width="100%" 
                        height="250" 
                        frameborder="0">
                    </iframe>
                </div>
            </div>

            <div class="card wide-card">
                <h3>üíß Gr√°fica Humedad</h3>
                <div class="grafana-container">
                    <iframe
                        src="http://192.168.1.90:3000/d-solo/adfsv7j/plantas?orgId=1&timezone=browser&refresh=5s&theme=dark&panelId=panel-1&__feature.dashboardSceneSolo=true"
                        width="100%" height="200" frameborder="0">
                    </iframe>
                </div>
            </div>

            <div class="card wide-card">
                <h3>üå°Ô∏è Tendencia de Temperatura (Hist√≥rico)</h3>
                <div class="grafana-container">
                    <iframe 
                        src="http://192.168.1.90:3000/d-solo/ad4fffw/tendencia-temperatura?orgId=1&from=1764721726063&to=1764743326063&timezone=browser&theme=dark&panelId=panel-1&__feature.dashboardSceneSolo=true" 
                        width="100%" 
                        height="250" 
                        frameborder="0">
                    </iframe>
                </div>
            </div>

            <div class="card wide-card">
                <h3>üìä An√°lisis de Correlaci√≥n (Humedad vs Temperatura)</h3>
                <div class="grafana-container">
                    <iframe 
                        src="http://192.168.1.90:3000/d-solo/ad8b667/humedad-y-temperatura?orgId=1&from=1764722404330&to=1764744004330&timezone=browser&theme=dark&panelId=panel-1&__feature.dashboardSceneSolo=true" 
                        width="100%" 
                        height="300" 
                        frameborder="0">
                    </iframe>
                </div>
                <p class="subtitle" style="text-align: center; margin-top: 10px;">
                    Comparativa para identificar patrones de secado.
                </p>
            </div>

            <!-- === NUEVA GR√ÅFICA: KPI 4 LUMINOSIDAD === -->
            <div class="card wide-card">
                <h3>‚òÄÔ∏è Ciclo de Iluminaci√≥n (D√≠a/Noche)</h3>
                <div class="grafana-container">
                    <iframe 
                        src="http://192.168.1.90:3000/d-solo/ad47l67/historial-luz?orgId=1&from=1764722780968&to=1764744380968&timezone=browser&theme=dark&panelId=panel-1&__feature.dashboardSceneSolo=true" 
                        width="100%" 
                        height="250" 
                        frameborder="0">
                    </iframe>
                </div>
            </div>

            <!-- === NUEVA SECCI√ìN: KPI 5 LOG DE EVENTOS === -->
            <div class="card wide-card">
                <h3>üõ°Ô∏è Registro de Seguridad (√öltimos Movimientos)</h3>
                <div class="grafana-container">
                    <iframe 
                        src="http://192.168.1.90:3000/d-solo/adhljrm/pir?orgId=1&from=1764723280754&to=1764744880754&timezone=browser&theme=dark&panelId=panel-1&__feature.dashboardSceneSolo=true" 
                        width="100%" 
                        height="250" 
                        frameborder="0">
                    </iframe>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACI√ìN WEBSOCKET
        const wsUrl = 'ws://192.168.1.90:8765';
        let socket;

        function connectWebSocket() {
            socket = new WebSocket(wsUrl);

            socket.onopen = function () {
                document.getElementById('connection-status').innerText = 'Conectado a Python';
                document.getElementById('connection-status').classList.replace('disconnected', 'connected');
            };

            socket.onmessage = function (event) {
                const data = JSON.parse(event.data);
                updateDashboard(data);
            };

            socket.onclose = function () {
                document.getElementById('connection-status').innerText = 'Reconectando...';
                document.getElementById('connection-status').classList.replace('connected', 'disconnected');
                setTimeout(connectWebSocket, 3000);
            };
        }

        function updateDashboard(data) {
            // KPI 1: Humedad
            if (data.humedad !== undefined) {
                const hum = data.humedad;
                document.getElementById('val-humedad').innerText = hum;
                const cardHum = document.getElementById('card-humedad');

                if (hum < 30) {
                    cardHum.style.border = "2px solid #ff4444";
                    document.getElementById('status-humedad').innerText = "¬°SUELO SECO!";
                } else if (hum > 70) {
                    cardHum.style.border = "2px solid #33b5e5";
                    document.getElementById('status-humedad').innerText = "Exceso de agua";
                } else {
                    cardHum.style.border = "1px solid #333";
                    document.getElementById('status-humedad').innerText = "Humedad √ìptima";
                }
            }

            // KPI 2: Temperatura
            if(data.temperatura !== undefined) {
                const temp = data.temperatura;
                document.getElementById('val-temp').innerText = temp;
                
                const cardTemp = document.getElementById('card-temp');
                const statusTemp = document.getElementById('status-temp');

                if (temp < 15) {
                    cardTemp.style.border = "2px solid #33b5e5";
                    statusTemp.innerText = "¬°Riesgo de Fr√≠o!";
                    statusTemp.style.color = "#33b5e5";
                } else if (temp > 28) {
                    cardTemp.style.border = "2px solid #ff4444";
                    statusTemp.innerText = "¬°Calor Excesivo!";
                    statusTemp.style.color = "#ff4444";
                } else {
                    cardTemp.style.border = "1px solid #333";
                    statusTemp.innerText = "Temperatura √ìptima";
                    statusTemp.style.color = "#666";
                }
            }

            // KPI 4: Luz
            if(data.luz !== undefined) {
                const luz = data.luz;
                document.getElementById('val-luz').innerText = luz;
                
                const statusLuz = document.getElementById('status-luz');
                const cardLuz = document.getElementById('card-luz');
                
                if(luz < 300) {
                    statusLuz.innerText = "üåë Oscuridad";
                    cardLuz.style.border = "1px solid #555";
                } else if (luz > 2000) {
                    statusLuz.innerText = "‚òÄÔ∏è Luz Directa (Alta)";
                    cardLuz.style.border = "2px solid #ffbb33";
                } else {
                    statusLuz.innerText = "‚òÅÔ∏è Luz Indirecta (√ìptima)";
                    cardLuz.style.border = "2px solid #00C851";
                }
            }

            // KPI 5: PIR (Movimiento)
            if(data.pir !== undefined) {
                const pirVal = data.pir;
                const cardPir = document.getElementById('card-pir');
                
                if (pirVal === 1) {
                    const now = new Date();
                    document.getElementById('val-pir').innerText = now.toLocaleTimeString();
                    
                    cardPir.style.backgroundColor = "#b71c1c"; 
                    cardPir.style.border = "2px solid #ff4444";
                } else {
                    cardPir.style.backgroundColor = "#1e1e1e";
                    cardPir.style.border = "1px solid #333";
                }
            }

            // MANEJO DE ALERTAS
            if (data.alerta !== undefined) {
                const alertBox = document.getElementById('alert-container');
                if (data.alerta !== "") {
                    alertBox.classList.remove('hidden');
                    document.getElementById('alert-message').innerText = "‚ö†Ô∏è " + data.alerta;
                } else {
                    alertBox.classList.add('hidden');
                }
            }

            // KPI 6: Extremos del D√≠a
            if (data.kpi6 !== undefined) {
                const kpi6 = data.kpi6;
                if (kpi6.humedad_max !== null) {
                    document.getElementById('kpi6-hum-max').innerText = kpi6.humedad_max;
                }
                if (kpi6.humedad_min !== null) {
                    document.getElementById('kpi6-hum-min').innerText = kpi6.humedad_min;
                }
                if (kpi6.temperatura_max !== null) {
                    document.getElementById('kpi6-temp-max').innerText = kpi6.temperatura_max;
                }
                if (kpi6.temperatura_min !== null) {
                    document.getElementById('kpi6-temp-min').innerText = kpi6.temperatura_min;
                }
            }

            // KPI 7: Horas en Estr√©s
            if (data.kpi7 !== undefined) {
                const kpi7 = data.kpi7;
                document.getElementById('kpi7-hum').innerText = kpi7.horas_humedad_critica || 0;
                document.getElementById('kpi7-temp').innerText = kpi7.horas_temperatura_critica || 0;
                document.getElementById('kpi7-luz').innerText = kpi7.horas_poca_luz || 0;
            }

            // KPI 8: Tasa de Secado
            if (data.kpi8 !== undefined) {
                const tasa = data.kpi8.tasa_secado || 0;
                document.getElementById('kpi8-tasa').innerText = tasa >= 0 ? `+${tasa}` : tasa;
                
                const statusEl = document.getElementById('kpi8-status');
                if (tasa < -10) {
                    statusEl.innerText = "‚ö†Ô∏è Secado r√°pido";
                    statusEl.style.color = "#ff4444";
                } else if (tasa < -5) {
                    statusEl.innerText = "Secado moderado";
                    statusEl.style.color = "#ffbb33";
                } else if (tasa > 5) {
                    statusEl.innerText = "Humedad aumentando";
                    statusEl.style.color = "#00C851";
                } else {
                    statusEl.innerText = "Estable";
                    statusEl.style.color = "#666";
                }
            }

            // KPI 9: Estado del Dispositivo
            if (data.kpi9 !== undefined && data.kpi9.ultima_conexion) {
                const lastConn = new Date(data.kpi9.ultima_conexion);
                const now = new Date();
                const diffMs = now - lastConn;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMins / 60);
                
                const cardConexion = document.getElementById('card-conexion');
                const tiempoEl = document.getElementById('kpi9-tiempo');
                const statusEl = document.getElementById('kpi9-status');
                
                if (diffMins < 5) {
                    tiempoEl.innerText = `Hace ${diffMins} min`;
                    cardConexion.style.border = "2px solid #00C851";
                    statusEl.innerText = "‚úÖ Conectado";
                    statusEl.style.color = "#00C851";
                } else if (diffMins < 10) {
                    tiempoEl.innerText = `Hace ${diffMins} min`;
                    cardConexion.style.border = "2px solid #ffbb33";
                    statusEl.innerText = "‚ö†Ô∏è Conexi√≥n lenta";
                    statusEl.style.color = "#ffbb33";
                } else if (diffMins < 60) {
                    tiempoEl.innerText = `Hace ${diffMins} min`;
                    cardConexion.style.border = "2px solid #ff8800";
                    statusEl.innerText = "‚ö†Ô∏è Desconexi√≥n reciente";
                    statusEl.style.color = "#ff8800";
                } else {
                    tiempoEl.innerText = diffHours > 1 ? `Hace ${diffHours}h` : `Hace ${diffMins} min`;
                    cardConexion.style.border = "2px solid #ff4444";
                    statusEl.innerText = "‚ùå Desconectado";
                    statusEl.style.color = "#ff4444";
                }
            }

            // KPI 10: Frecuencia de Alertas
            if (data.kpi10 !== undefined) {
                const kpi10 = data.kpi10;
                document.getElementById('kpi10-hum').innerText = kpi10.alertas_humedad_7d || 0;
                document.getElementById('kpi10-pir').innerText = kpi10.detecciones_pir_24h || 0;
            }
        }

        connectWebSocket();
    </script>
</body>

</html>